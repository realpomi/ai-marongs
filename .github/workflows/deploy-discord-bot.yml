name: Deploy Discord Bot

on:
  push:
    branches: [main]
    paths:
      - 'discord-bot/**'
      - '.github/workflows/deploy-discord-bot.yml'
  workflow_dispatch:

env:
  DISCORD_WEBHOOK_URL: https://discord.com/api/webhooks/1455121065524330675/C-MYiWr8WAOymA1dCbstYnnd0N5kO8YY8hTDzwSWYsOTg5OfSN_JWl0cRsfByBlu0Hqs
  SERVICE_NAME: Discord Bot

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Notify build start
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"ğŸš€ ë¹Œë“œ ì‹œì‘\", \"description\": \"**${{ env.SERVICE_NAME }}** ë°°í¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.\", \"color\": 3447003, \"fields\": [{\"name\": \"Branch\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true}, {\"name\": \"Commit\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": true}], \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
            ${{ env.DISCORD_WEBHOOK_URL }}

      - name: Checkout
        uses: actions/checkout@v4

      - name: Stop existing container
        run: |
          docker stop discord-bot || true
          docker rm discord-bot || true

      - name: Build Docker image
        run: |
          docker build -t discord-bot:latest ./discord-bot

      - name: Run Discord Bot container
        run: |
          docker run -d \
            --name discord-bot \
            --network home-network \
            -e DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }} \
            -e NATS_URL=nats://nats:4222 \
            -e DEBUG_WEBHOOK_URL=${{ secrets.DEBUG_WEBHOOK_URL }} \
            --restart unless-stopped \
            discord-bot:latest

      - name: Verify deployment
        run: |
          sleep 5
          docker ps | grep discord-bot
          docker logs discord-bot --tail 20

      - name: Notify build success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"âœ… ë¹Œë“œ ì™„ë£Œ\", \"description\": \"**${{ env.SERVICE_NAME }}** ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\", \"color\": 5763719, \"fields\": [{\"name\": \"Branch\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true}, {\"name\": \"Commit\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": true}], \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
            ${{ env.DISCORD_WEBHOOK_URL }}

      - name: Notify build failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"âŒ ë¹Œë“œ ì‹¤íŒ¨\", \"description\": \"**${{ env.SERVICE_NAME }}** ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\", \"color\": 15548997, \"fields\": [{\"name\": \"Branch\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true}, {\"name\": \"Commit\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": true}, {\"name\": \"Workflow\", \"value\": \"[ë¡œê·¸ í™•ì¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}], \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]}" \
            ${{ env.DISCORD_WEBHOOK_URL }}
